local Players = game:GetService("Players")
local RS = game:GetService("RunService")
local WS = game:GetService("Workspace")

local AimlockState = true
local Locked = false
local Victim = nil

local Key = Enum.KeyCode.C

-- Function to check if a player is alive
local function isAlive(player)
    return player and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

-- Function to lock onto the closest player to the cursor
local function lockOntoClosest()
    if AimlockState then
        Locked = not Locked
        if Locked then
            Victim = getClosestAlivePlayerToCursor()
            if Victim then
                print("Locked onto: " .. Victim.Name)
            else
                Locked = false
                print("No valid target found.")
            end
        else
            Victim = nil
            print("Unlocked!")
        end
    else
        print("Aimlock is not enabled!")
    end
end

-- Function to get the closest alive player to the cursor
local function getClosestAlivePlayerToCursor()
    local closestPlayer
    local shortestDistance = math.huge
    local mousePos = Players.LocalPlayer:GetMouse().Hit.Position

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and isAlive(player) then
            local pos = WS.CurrentCamera:WorldToViewportPoint(player.Character.PrimaryPart.Position)
            local magnitude = (Vector2.new(pos.X, pos.Y) - Vector2.new(mousePos.X, mousePos.Y)).magnitude
            if magnitude < shortestDistance then
                closestPlayer = player
                shortestDistance = magnitude
            end
        end
    end

    return closestPlayer
end

-- Listen for key presses
Players.LocalPlayer:GetMouse().KeyDown:Connect(function(key)
    if key.KeyCode == Key then
        lockOntoClosest()
    end
end)

-- Listen for character death
Players.PlayerAdded:Connect(function(player)
    player.Character:WaitForChild("Humanoid").Died:Connect(function()
        if Victim == player then
            Victim = nil
            Locked = false
            print("Target has been eliminated. Unlocking aimlock.")
        end
    end)
end)
